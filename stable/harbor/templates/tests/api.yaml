{{- if .Values.tests.api.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ template "harbor.test" . }}-api"
  labels:
{{ include "harbor.labels" . | indent 4 }}
    component: tests-api
  annotations:
    {{- if .Values.tests.api.podAnnotations }}
      {{ toYaml .Values.tests.api.podAnnotations | indent 4 }}
    {{- end }}
    helm.sh/hook: test-success
spec:
  {{- with .Values.imagePullSecrets }}
  imagePullSecrets:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  containers:
    - name: api-tests
      image: {{ .Values.tests.api.image.repository }}:{{ .Values.tests.api.image.tag }}
      imagePullPolicy: {{ .Values.imagePullPolicy }}
      env:
        - name: HARBOR_IP
          value: {{ .Values.externalURL | replace "https://" "" }}
        - name: HARBOR_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ template "harbor.core" . }}
              key: HARBOR_ADMIN_PASSWORD
        {{- if and .Values.notary.enabled (eq .Values.expose.type "ingress") }}
        - name: NOTARY_URL
          value: https://{{ .Values.expose.ingress.hosts.notary }}
        {{- end }}
        - name: ROBOT_OPTIONS
          value: "{{ template "harbor.tests.api.options" . }}"
        {{- if and .Values.tests.dockerCredentials.username .Values.tests.dockerCredentials.password }}
        - name: DOCKER_USER
          value: {{ .Values.tests.dockerCredentials.username }}
        - name: DOCKER_PWD
          valueFrom:
            secretKeyRef:
              name: {{ template "harbor.test" . }}
              key: .docker-password
        {{- end }}
        {{- if .Values.tests.imagesPullRepository }}
        - name: HARBOR_TEST_IMAGES_REPOSITORY
          value: {{ .Values.tests.imagesPullRepository }}
        {{- end }}
      volumeMounts:
        {{- if .Values.expose.tls.enabled }}
        - name: ca-download
          mountPath: /usr/share/pki/trust/anchors/harbor-ca.crt
          subPath: ca.crt
          readOnly: true
        {{- end }}
        {{- if .Values.caBundleSecretName }}
        - name: ca-bundle-certs
          mountPath: /usr/share/pki/trust/anchors/custom-ca.crt
          subPath: ca.crt
          readOnly: true
        {{- end }}
      securityContext:
        privileged: true
        allowPrivilegeEscalation: true
{{- if .Values.tests.api.resources }}
      resources:
{{ toYaml .Values.tests.api.resources | indent 8 }}
{{- end }}
  volumes:
    {{- if .Values.expose.tls.enabled }}
    - name: ca-download
      secret:
      {{- if .Values.caSecretName }}
        secretName: {{ .Values.caSecretName }}
      {{- else if eq (include "harbor.autoGenCertForIngress" .) "true" }}
        secretName: "{{ template "harbor.ingress" . }}"
      {{- else if eq (include "harbor.autoGenCertForNginx" .) "true" }}
        secretName: {{ template "harbor.tlsSecretForNginx" . }}
      {{- end }}
    {{- end }}
    {{- if .Values.caBundleSecretName }}
{{ include "harbor.caBundleVolume" . | indent 4 }}
    {{- end }}
  restartPolicy: Never
{{- end }}
